@model (List<Allergie> Allergies, List<Antecedent> Antecedents)

@if (TempData["MessageSucces"] != null)

{
	<div id="tempMessage" class="alert alert-success">
		@TempData["MessageSucces"]
	</div>
}

@if (TempData["MessageErreur"] != null)

{
	<div id="tempMessage" class="alert alert-danger">
		@TempData["MessageErreur"]
	</div>
}


<h1>Allergies</h1>
@* <form asp-action="Index" method="get" class="mt-3">
	<div class="col-4 input-group mb-3">
		<input type="text" name="filtreAllergies" class="form-control" placeholder="Rechercher par allergies" value="@ViewData["FiltreActuelAllergie"]" />
		<input type="hidden" name="filtreAntecedents" value="@ViewData["FiltreActuelAntecedent"]" />
		<input type="hidden" name="OrdreTriAllergie" value="@ViewData["TriActuelAllergie"]" />
		<input type="hidden" name="OrdreTriAntecedent" value="@ViewData["TriActuelAntecedent"]" />
		<button class="btn btn-outline-primary" type="submit">Rechercher</button>
	</div>
</form> *@
<input type="text" class="col-4 form-control" id="RechercheEntreeAllergie" placeholder="Rechercher..."
	   value="@ViewData["FiltreActuel"]" />

<table class="table table-striped table-hover">
	<thead>
		<tr>
			<th>
				<a class="text-dark" asp-action="Index" asp-route-OrdreTriAllergie="@ViewData["NomAllergieParamTri"]" asp-route-filtreAllergies="@ViewData["FiltreActuelAllergie"]">
					Nom
					@if ((ViewData["TriActuelAllergie"]?.ToString() ?? "") == "nomAllergie_desc")
					{
						<i class="bi bi-arrow-down-short"></i>
					}
					else if ((ViewData["TriActuelAllergie"]?.ToString() ?? "") == "")
					{
						<i class="bi bi-arrow-up-short"></i>
					}
				</a>
			</th>
			<th>Détail</th>
			<th>Modifier</th>
			<th>Supprimer</th>
		</tr>
	</thead>
	<tbody id="AllergieListContainer">
		@foreach (var allergie in Model.Allergies)

		{
			<tr>
				<td>@allergie.Nom</td>
				<td>
					<a asp-action="Detail" asp-controller="ContreIndications" asp-route-id="@allergie.AllergieId" asp-route-type="Allergie">
						<i class="bi bi-eye"></i>
					</a>
				</td>
				<td>
					<a asp-action="Modifier" asp-controller="ContreIndications" asp-route-id="@allergie.AllergieId" asp-route-type="Allergie">
						<i class="bi bi-pen"></i>
					</a>
				</td>
				<td>
					<a asp-action="Supprimer" asp-controller="ContreIndications" asp-route-id="@allergie.AllergieId" asp-route-type="Allergie" onclick="return confirm('Êtes-vous sûr de vouloir supprimer cette allergie ?');">
						<i class="bi bi-trash"></i>
					</a>
				</td>
			</tr>
		}
	</tbody>
</table>

<div class="row">
	<div class="col-8">
		<p>
			<a asp-action="Ajouter" asp-route-type="Allergie" class="btn btn-primary">Ajouter une allergie</a>
		</p>
	</div>
</div>


<h1>Antécédents</h1>
<input type="text" class="col-4 form-control" id="RechercheEntreeAntecedent" placeholder="Rechercher..."
	   value="@ViewData["FiltreActuel"]" />

<table class="table table-striped table-hover">
	<thead>
		<tr>
			<th>
				<a class="text-dark" asp-action="Index" asp-route-OrdreTriAntecedent="@ViewData["NomAntecedentParamTri"]" asp-route-filtreAntecedents="@ViewData["FiltreActuelAntecedent"]">
					Nom
					@if ((ViewData["TriActuelAntecedent"]?.ToString() ?? "") == "nomAntecedent_desc")
					{
						<i class="bi bi-arrow-down-short"></i>
					}
					else if ((ViewData["TriActuelAntecedent"]?.ToString() ?? "") == "")
					{
						<i class="bi bi-arrow-up-short"></i>
					}
				</a>
			</th>
			<th>Détail</th>
			<th>Modifier</th>
			<th>Supprimer</th>
		</tr>
	</thead>
	<tbody id="AntecedentListContainer">
		@foreach (var antecedent in Model.Antecedents)

		{
			<tr>
				<td>@antecedent.Nom</td>
				<td>
					<a asp-action="Detail" asp-controller="ContreIndications" asp-route-id="@antecedent.AntecedentId" asp-route-type="Antecedent">
						<i class="bi bi-eye"></i>
					</a>
				</td>
				<td>
					<a asp-action="Modifier" asp-controller="ContreIndications" asp-route-id="@antecedent.AntecedentId" asp-route-type="Antecedent">
						<i class="bi bi-pen"></i>
					</a>
				</td>
				<td>
					<a asp-action="Supprimer" asp-controller="ContreIndications" asp-route-id="@antecedent.AntecedentId" asp-route-type="Antecedent" onclick="return confirm('Êtes-vous sûr de vouloir supprimer cet antécédent ?');">
						<i class="bi bi-trash"></i>
					</a>
				</td>
			</tr>
		}
	</tbody>
</table>

<div class="row">
	<div class="col-8">
		<p>
			<a asp-action="Ajouter" asp-route-type="Antecedent" class="btn btn-primary">Ajouter un antécédent</a>
		</p>
	</div>
</div>

<script>
	window.addEventListener('DOMContentLoaded', (event) => {
		const tempMessage = document.getElementById("tempMessage");
		if (tempMessage) {
			setTimeout(() => {
				tempMessage.style.display = "none";
			}, 3000);
		}
	});
</script>

<script>
	const RechercheEntreeAllergie = document.getElementById('RechercheEntreeAllergie');
	const RechercheEntreeAntecedent = document.getElementById('RechercheEntreeAntecedent');

	let timeoutId;

	function majListe() {
		const filtreAllergies = encodeURIComponent(RechercheEntreeAllergie.value);
		const filtreAntecedents = encodeURIComponent(RechercheEntreeAntecedent.value);
		const triAllergie = '@ViewData["TriActuelAllergie"]';
		const triAntecedent = '@ViewData["TriActuelAntecedent"]';

		const url = `@Url.Action("Index")?filtreAllergies=${filtreAllergies}&filtreAntecedents=${filtreAntecedents}&OrdreTriAllergie=${triAllergie}&OrdreTriAntecedent=${triAntecedent}`;

		history.pushState(null, '', url);

		fetch(url, {
			headers: { 'X-Requested-With': 'XMLHttpRequest' }
		})
			.then(response => response.text())
			.then(html => {
				const tempDiv = document.createElement('div');
				tempDiv.innerHTML = html;

				document.getElementById('AllergieListContainer').innerHTML = tempDiv.querySelector('#AllergieListContainer').innerHTML;
				document.getElementById('AntecedentListContainer').innerHTML = tempDiv.querySelector('#AntecedentListContainer').innerHTML;
			});
	}

	RechercheEntreeAllergie.addEventListener('input', () => {
		clearTimeout(timeoutId);
		timeoutId = setTimeout(majListe, 500);
	});

	RechercheEntreeAntecedent.addEventListener('input', () => {
		console.log("Je suis dans l'event antécédent")
		clearTimeout(timeoutId);
		timeoutId = setTimeout(majListe, 500);
	});
</script>



